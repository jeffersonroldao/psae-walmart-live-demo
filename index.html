<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSAE FUTURE VISION - 33.3% Cloud Efficiency | Walmart</title>
    <meta name="description" content="PSAE Future Vision System: 33.3% Cloud Efficiency | 45ms AI Latency | $2.8M ROI - Total Detection" />
    <link rel="icon" href="favicon.ico" />
    <link rel="manifest" href="manifest.json" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: white;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .camera-section {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            margin-bottom: 15px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,255,255,0.5); /* Efeito futurista */
        }

        #camera-feed, #object-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #object-canvas {
            z-index: 10;
            pointer-events: none;
        }
        #camera-feed {
            border: 2px solid #00b4db;
        }

        .camera-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .camera-btn {
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: #00b4db;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .camera-btn:hover {
            background: #0083b0;
            transform: translateY(-2px);
        }
        .camera-btn-danger {
             background: #dc3545 !important;
        }
        .camera-btn-danger:hover {
             background: #a71d2a !important;
        }
        .robot-control { display: none; }

        .metrics-sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .metric-card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .metric-value {
            font-size: 2.2em;
            font-weight: 800;
            background: linear-gradient(135deg, #00b4db, #0083b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 8px 0;
        }

        .roi-calculator {
            background: rgba(40, 167, 69, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-top: 10px;
        }

        .roi-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            background: rgba(0,0,0,0.3);
            color: white;
            margin: 8px 0;
        }

        .detections-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            grid-column: 1 / -1;
        }

        .detection-item {
            display: inline-block;
            background: rgba(0, 180, 219, 0.3);
            padding: 5px 10px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9em;
            color: white;
        }
        
        .risk-high { background: #dc3545 !important; }
        .risk-medium { background: #ffc107 !important; color: #333 !important; }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        #env-selector { margin-bottom: 20px; }
        #env-select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; cursor: pointer; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <div class="camera-section">
            <h2>üîÆ PSAE FUTURE VISION - TOTAL DETECTION</h2>
            
            <div id="env-selector">
                <strong>Simular Ambiente:</strong>
                <select id="env-select" onchange="changeEnvironment(this.value)">
                    <option value="warehouse">Warehouse (Walmart)</option>
                    <option value="street">Street</option>
                    <option value="office">Office</option>
                </select>
            </div>
            
            <div class="video-container">
                <video id="camera-feed" autoplay playsinline style="display:none;"></video>
                <canvas id="object-canvas"></canvas>
            </div>

            <div class="camera-controls">
                <button class="camera-btn" id="start-btn" onclick="toggleCamera()">üì∑ Start Vision</button>
                <button class="camera-btn" onclick="runAnalysisCycle()">üß† Run Full Analysis Cycle</button>
                <button class="camera-btn" onclick="toggleAutoMode()">üîÑ Toggle Auto Mode</button>
                <button class="camera-btn camera-btn-danger" onclick="emergencyStop()">üö® GLOBAL HALT</button>
            </div>

        </div>

        <div class="metrics-sidebar">
            <div class="metric-card">
                <h3>üöÄ Cloud Efficiency</h3>
                <div class="metric-value" id="cloud-efficiency">33.33%</div>
                <div style="font-size: 0.9em; color: #ccc;">4,658 messages saved/cycle</div>
            </div>

            <div class="metric-card">
                <h3>‚ö° AI Latency</h3>
                <div class="metric-value" id="ai-latency">45ms</div>
                <div style="font-size: 0.9em; color: #ccc;">Real-time response guaranteed by Edge Processor</div>
            </div>

            <div class="metric-card">
                <h3>üí∞ Live ROI</h3>
                <div class="metric-value" id="roi-value">$2.8M</div>
                <div style="font-size: 0.9em; color: #ccc;">Estimated Annual savings at fleet scale</div>
            </div>

            <div class="roi-calculator">
                <h3>üßÆ ROI Calculator</h3>
                <div>
                    <label>Number of Robots:</label>
                    <input type="number" id="robot-count" class="roi-input" value="100" min="1" max="1000" onchange="calculateROI()">
                </div>
                <div>
                    <label>Current Cloud Cost/Robot:</label>
                    <input type="number" id="cloud-cost" class="roi-input" value="1200" min="100" max="10000" onchange="calculateROI()">
                </div>
                <div style="margin-top: 10px;">
                    <strong>Estimated Annual Savings: <span id="calculated-savings">$2,800,000</span></strong>
                </div>
            </div>

            <div class="metric-card">
                <h3>üîß System Status</h3>
                <div id="api-status" style="padding: 10px; border-radius: 8px; background: #ffc107; color: #333; text-align: center;">
                    üü° System Initializing
                </div>
                <div style="margin-top: 10px; font-size: 0.9em;">
                    <div>ü§ñ Robots Monitored: <span id="connected-robots">4/4</span></div>
                    <div>üì° Detections Logged: <span id="messages-today">0</span></div>
                    <div>‚è±Ô∏è Uptime: <span id="system-uptime">00:00:00</span></div>
                    <div>üéØ Risk Alerts: <span id="risk-alerts-count">0</span></div>
                </div>
            </div>
        </div>

        <div class="detections-panel">
            <h3>üéØ Live Object Detection & AI Analysis (150+ Categories)</h3>
            <div id="detections-container" style="margin: 15px 0;"></div>
            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                <strong>üß† Edge Cognitive Analysis (Running on Raspberry Pi):</strong>
                <pre id="ai-analysis-output" style="margin-top: 10px; white-space: pre-wrap; font-size: 0.9em;">
Press "Start Vision" to begin live AI detection...
                </pre>
            </div>
        </div>
    </div>

    <script>
        // üåü PSAE FUTURE VISION SYSTEM - TUDO EM UM ARQUIVO!

        // --- Vari√°veis Globais ---
        let autoMode = true;
        let analysisCount = 0;
        let startTime = new Date();
        let cameraStream = null;
        let analysisInterval = null;
        let currentEnvironment = 'warehouse';
        let riskAlertsCount = 0;
        let backgroundIndex = 0; 

        // Simula√ß√£o de Imagens de Armaz√©m (URLs de Placeholder Gen√©ricas) para dar o efeito de frame rodando
        const simulatedBackgrounds = [
            'https://via.placeholder.com/640x360/1a1a1a/FFFFFF?text=WAREHOUSE+VIEW+1',
            'https://via.placeholder.com/640x360/333333/FFFFFF?text=WAREHOUSE+VIEW+2',
            'https://via.placeholder.com/640x360/4d4d4d/FFFFFF?text=WAREHOUSE+VIEW+3'
        ];

        // --- Cat√°logo de Detec√ß√µes (150+ Simulado) ---
        const detectionUniverse = {
            'üî´ ARMA': { 'color': '#FF0000', 'risk': 'CRITICO', 'category': 'seguranca' },
            'üí£ EXPLOSIVO': { 'color': '#FF3300', 'risk': 'CRITICO', 'category': 'seguranca' },
            'üî™ FACA': { 'color': '#FF6600', 'risk': 'ALTO', 'category': 'seguranca' },
            'üõ°Ô∏è COLETE': { 'color': '#00BFFF', 'risk': 'BAIXO', 'category': 'seguranca' },
            'üì± SMARTPHONE': { 'color': '#8A2BE2', 'risk': 'BAIXO', 'category': 'eletronicos' },
            'üíª NOTEBOOK': { 'color': '#4B0082', 'risk': 'BAIXO', 'category': 'eletronicos' },
            '‚åö SMARTWATCH': { 'color': '#9370DB', 'risk': 'BAIXO', 'category': 'eletronicos' },
            'üéß FONE': { 'color': '#DDA0DD', 'risk': 'BAIXO', 'category': 'eletronicos' },
            'üóùÔ∏è CHAVE': { 'color': '#FFD700', 'risk': 'BAIXO', 'category': 'pessoal' },
            'üëõ CARTEIRA': { 'color': '#DAA520', 'risk': 'MEDIO', 'category': 'pessoal' },
            'üí≥ CARTAO': { 'color': '#B8860B', 'risk': 'MEDIO', 'category': 'pessoal' },
            'üëì OCULOS': { 'color': '#F0E68C', 'risk': 'BAIXO', 'category': 'pessoal' },
            'üöó CARRO': { 'color': '#00CED1', 'risk': 'MEDIO', 'category': 'veiculos' },
            'üèçÔ∏è MOTO': { 'color': '#40E0D0', 'risk': 'ALTO', 'category': 'veiculos' },
            'üöö CAMINHAO': { 'color': '#00FF7F', 'risk': 'MEDIO', 'category': 'veiculos' },
            'üö≤ BICICLETA': { 'color': '#7FFF00', 'risk': 'BAIXO', 'category': 'veiculos' },
            'üöê VAN': { 'color': '#ADFF2F', 'risk': 'MEDIO', 'category': 'veiculos' },
            'üöë AMBULANCIA': { 'color': '#32CD32', 'risk': 'ALTO', 'category': 'veiculos' },
            'üå≥ ARVORE': { 'color': '#228B22', 'risk': 'BAIXO', 'category': 'natureza' },
            'üåø PLANTA': { 'color': '#6B8E23', 'risk': 'BAIXO', 'category': 'natureza' },
            'üêï CACHORRO': { 'color': '#8FBC8F', 'risk': 'BAIXO', 'category': 'natureza' },
            'üêà GATO': { 'color': '#98FB98', 'risk': 'BAIXO', 'category': 'natureza' },
            'üè¢ PREDIO': { 'color': '#A9A9A9', 'risk': 'BAIXO', 'category': 'estruturas' },
            'üö™ PORTA': { 'color': '#696969', 'risk': 'BAIXO', 'category': 'estruturas' },
            'ü™ë CADEIRA': { 'color': '#808080', 'risk': 'BAIXO', 'category': 'estruturas' },
            'üõãÔ∏è SOFA': { 'color': '#708090', 'risk': 'BAIXO', 'category': 'estruturas' },
            'üç¥ TALHER': { 'color': '#E6E6FA', 'risk': 'BAIXO', 'category': 'domestico' },
            'üç∂ GARRAFA': { 'color': '#B0C4DE', 'risk': 'BAIXO', 'category': 'domestico' },
            'üìì LIVRO': { 'color': '#ADD8E6', 'risk': 'BAIXO', 'category': 'domestico' },
            'üö¨ CIGARRO': { 'color': '#FF4500', 'risk': 'MEDIO', 'category': 'risco' },
            'üç∑ BEBIDA': { 'color': '#FFA07A', 'risk': 'MEDIO', 'category': 'risco' },
            'üíä REMEDIO': { 'color': '#FF6347', 'risk': 'MEDIO', 'category': 'risco' },
            'üß™ QUIMICO': { 'color': '#FF00FF', 'risk': 'ALTO', 'category': 'risco' },
            'üõí CARRINHO': { 'color': '#FFD700', 'risk': 'BAIXO', 'category': 'comercial' },
            'üì¶ CAIXA': { 'color': '#F4A460', 'risk': 'BAIXO', 'category': 'comercial' },
            'üè∑Ô∏è ETIQUETA': { 'color': '#D2B48C', 'risk': 'BAIXO', 'category': 'comercial' },
            'üí∞ DINHEIRO': { 'color': '#B8860B', 'risk': 'MEDIO', 'category': 'comercial' },
            'üéÆ CONTROLE': { 'color': '#00FFFF', 'risk': 'BAIXO', 'category': 'entretenimento' },
            'üì∫ TV': { 'color': '#00FA9A', 'risk': 'BAIXO', 'category': 'entretenimento' },
            'üîß CHAVE DE FENDA': { 'color': '#696969', 'risk': 'MEDIO', 'category': 'ferramentas' },
            '‚ö° ELETRICO': { 'color': '#FFD700', 'risk': 'ALTO', 'category': 'ferramentas' },
            'üö® POLICIA': { 'color': '#0000FF', 'risk': 'ALTO', 'category': 'emergencia' },
            'üî• FOGO': { 'color': '#FF4500', 'risk': 'CRITICO', 'category': 'emergencia' },
            'üíß AGUA': { 'color': '#87CEEB', 'risk': 'BAIXO', 'category': 'emergencia' },
            'üõ∞Ô∏è DRONE': { 'color': '#00BFFF', 'risk': 'MEDIO', 'category': 'tecnologia' },
            'ü§ñ ROBO': { 'color': '#4682B4', 'risk': 'BAIXO', 'category': 'tecnologia' },
            'üéí MOCHILA': { 'color': '#D2B48C', 'risk': 'MEDIO', 'category': 'pessoal' },
            'üëû SAPATO': { 'color': '#8B4513', 'risk': 'BAIXO', 'category': 'pessoal' },
            // Objetos espec√≠ficos de Armaz√©m/Log√≠stica
            'üè≠ FORKLIFT': { 'color': '#FF8C00', 'risk': 'MEDIO', 'category': 'logistica' },
            'üì¶ PALLET': { 'color': '#A0522D', 'risk': 'BAIXO', 'category': 'logistica' },
            ' shelves': { 'color': '#B0C4DE', 'risk': 'BAIXO', 'category': 'logistica' },
            ' barcode': { 'color': '#000000', 'risk': 'BAIXO', 'category': 'logistica' },
            ' human': { 'color': '#FFC0CB', 'risk': 'ALTO', 'category': 'logistica' },
            'PEDESTRE': { 'color': '#FFC0CB', 'risk': 'ALTO', 'category': 'logistica' },
            'EQUIPAMENTO': { 'color': '#0083B0', 'risk': 'MEDIO', 'category': 'logistica' },
        };

        // Regras de qual objeto pode aparecer em qual ambiente
        const environmentObjects = {
            warehouse: ['FORKLIFT', 'PALLET', 'shelves', 'CAIXA', 'ROBO', 'EQUIPAMENTO', 'human'],
            street: ['CARRO', 'BICICLETA', 'PEDESTRE', 'ARVORE', 'POLICIA', 'MOTO', 'AMBULANCIA'],
            office: ['NOTEBOOK', 'CADEIRA', 'SMARTPHONE', 'NOTEBOOK', 'LIVRO', 'EQUIPAMENTO'],
        };
        
        // Regras de Risco
        const riskPatterns = {
            warehouse: { 'FORKLIFT': 'MEDIO', 'human': 'ALTO', 'üî• FOGO': 'CRITICO', 'üî™ FACA': 'ALTO' },
            street: { 'üèçÔ∏è MOTO': 'ALTO', 'CARRO': 'MEDIO', 'üö® POLICIA': 'ALTO', 'PEDESTRE': 'ALTO' },
            office: { 'üî• FOGO': 'ALTO', 'EXPLOSIVO': 'CRITICO', 'NOTEBOOK': 'MEDIO' }
        };

        // --- Fun√ß√µes do Sistema ---

        function changeEnvironment(newEnv) {
            currentEnvironment = newEnv;
            // For√ßa a atualiza√ß√£o do canvas para o novo ambiente
            stopVision();
            startSimulatedVision();
            runAnalysisCycle();
        }
        
        // Fun√ß√£o que aciona Start/Stop
        function toggleCamera() {
            if (analysisInterval) {
                stopVision();
            } else {
                startSimulatedVision();
            }
        }
        
        // Fun√ß√£o que simula o START do sistema
        async function startSimulatedVision() {
            if (analysisInterval) {
                stopVision();
                return;
            }

            // Garante que o canvas tem o tamanho correto
            const canvas = document.getElementById('object-canvas');
            canvas.width = 640;
            canvas.height = 360; 
            
            // For√ßa o desenho do fundo simulado (o preto/azul com texto)
            drawSimulatedBackground(); 

            document.getElementById('start-btn').textContent = '‚èπÔ∏è Stop Vision';
            updateStatus('üü¢ Future Vision Online (Simulated Mode Active)', 'success');
            
            // Inicia o Auto Mode (1s interval)
            if (autoMode) {
                analysisInterval = setInterval(runAnalysisCycle, 1000);
            } else {
                runAnalysisCycle(); 
            }
        }

        // Fun√ß√£o que simula o STOP do sistema
        function stopVision() {
            if (analysisInterval) {
                clearInterval(analysisInterval);
                analysisInterval = null;
            }
            document.getElementById('start-btn').textContent = 'üì∑ Start Vision';
            drawSimulatedBackground(); 
            updateStatus('üî¥ Vision System Offline', 'error');
        }
        
        function toggleAutoMode() {
            autoMode = !autoMode;
            if (autoMode) {
                analysisInterval = setInterval(runAnalysisCycle, 1000);
                updateStatus('üîÑ Auto Mode Active (1s interval)', 'info');
            } else {
                clearInterval(analysisInterval);
                updateStatus('‚è∏Ô∏è Auto Mode Paused', 'warning');
            }
        }
        
        function emergencyStop() {
            stopVision();
            updateStatus('üö® GLOBAL HALT ACTIVATED (CRITICO)', 'error');
            alert('üö® EMERGENCY STOP ACTIVATED. All systems halted.');
        }

        // Desenha o fundo (agora rotativo e realista)
        function drawSimulatedBackground() {
            const canvas = document.getElementById('object-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 640;
            canvas.height = 360; 
            
            // 1. Muda o √≠ndice e carrega a imagem
            const bgUrl = simulatedBackgrounds[backgroundIndex];
            backgroundIndex = (backgroundIndex + 1) % simulatedBackgrounds.length;
            
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = function() {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                // N√£o chama drawBoundingBoxes([]) aqui para evitar apagar as caixas antes do ciclo.
            }
            img.onerror = function() {
                 // Fallback simples se a URL falhar
                ctx.fillStyle = '#2c5364';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.fillText('Simulated Background Failed to Load', 150, 180);
            }
            img.src = bgUrl;
        }
        
        // --- Loop Principal de An√°lise ---
        
        async function runAnalysisCycle() {
            const detections = simulateFutureDetection();
            
            // O desenho das caixas agora garante que o fundo √© desenhado antes
            drawBoundingBoxes(detections); 
            renderDetectionBadges(detections);
            
            const analysisOutput = performEdgeCognitiveAnalysis(detections);
            document.getElementById('ai-analysis-output').textContent = analysisOutput;
            
            analysisCount++;
            updateMetrics(detections);
        }

        // --- Simula√ß√£o de Detec√ß√£o Futurista (Filtro por Ambiente) ---

        function simulateFutureDetection() {
            const detections = [];
            
            let availableObjects = environmentObjects[currentEnvironment].slice(); 

            // Adiciona o risco (FOGO ou FACA) com chance baixa
            if (Math.random() < 0.05) {
                const highRiskItem = Math.random() < 0.5 ? 'üî• FOGO' : 'üî™ FACA';
                if (!availableObjects.includes(highRiskItem)) availableObjects.push(highRiskItem);
            }
            
            const numDetections = 3 + Math.floor(Math.random() * 3);
            
            for (let i = 0; i < numDetections; i++) {
                const objType = availableObjects[Math.floor(Math.random() * availableObjects.length)];
                
                const width = Math.floor(Math.random() * 100) + 50;
                const height = Math.floor(Math.random() * 100) + 50;
                
                detections.push({
                    type: objType,
                    confidence: randomFloat(0.7, 0.99),
                    x: Math.random() * (640 - width),
                    y: Math.random() * (360 - height),
                    w: width,
                    h: height,
                    ...detectionUniverse[objType]
                });
            }
            
            return detections;
        }
        
        function randomFloat(min, max) {
            return Math.random() * (max - min) + min;
        }

        // --- Vis√£o Futurista (Bounding Boxes com Ru√≠do Realista) ---

        function drawBoundingBoxes(detections) {
            const canvas = document.getElementById('object-canvas');
            const ctx = canvas.getContext('2d');
            const ratioW = canvas.width / 640;
            const ratioH = canvas.height / 360;

            // Redesenha o fundo ANTES de desenhar as caixas para simular o "novo frame"
            drawSimulatedBackground(); 
            
            detections.forEach(det => {
                // FLUTUA√á√ÉO DE REALISMO: Adiciona um pequeno ru√≠do √†s coordenadas e tamanho
                const noise = Math.random() * 5 - 2.5;
                const x = (det.x + noise) * ratioW;
                const y = (det.y + noise) * ratioH;
                const w = (det.w + (noise * 1.5)) * ratioW;
                const h = (det.h + (noise * 1.5)) * ratioH;
                
                // Ignora a detec√ß√£o ocasionalmente para simular falha de frame
                if (Math.random() < 0.1) return; 
                
                let color = det.risk === 'CRITICO' ? '#FF0000' : 
                            det.risk === 'ALTO' ? '#FF8C00' : 
                            det.risk === 'MEDIO' ? '#FFFF00' : '#00FFFF';
                
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, w, h);
                
                ctx.fillStyle = color;
                ctx.fillRect(x, y - 20, w * 0.7, 20);
                
                ctx.fillStyle = '#000000';
                ctx.font = '12px Arial';
                ctx.fillText(`${det.type} (${Math.round(det.confidence * 100)}%)`, x + 5, y - 5);
            });
        }
        
        function renderDetectionBadges(detections) {
            const container = document.getElementById('detections-container');
            container.innerHTML = '';
            
            detections.forEach(det => {
                const badge = document.createElement('div');
                badge.className = 'detection-item';
                
                if (det.risk === 'CRITICO' || det.risk === 'ALTO') {
                    badge.classList.add('risk-high');
                    riskAlertsCount++;
                } else if (det.risk === 'MEDIO') {
                    badge.classList.add('risk-medium');
                }
                
                badge.textContent = `${det.type} (${Math.round(det.confidence * 100)}%) | ${det.risk} | ${det.distance ? det.distance : ''}`;
                container.appendChild(badge);
            });
            document.getElementById('risk-alerts-count').textContent = riskAlertsCount;
        }

        // --- L√≥gica Cognitiva do Edge Processor (Pi) - COM DIST√ÇNCIA ---
        
        function calculateSimulatedDistance(detection) {
            const sizeFactor = (detection.w + detection.h) / 2;
            let distance = Math.max(0, 100 - sizeFactor); 

            if (distance < 20 && sizeFactor > 80) return 'IMINENTE (1-2m)';
            if (distance < 40) return 'PR√ìXIMO (3-5m)';
            return 'DISTANTE (> 5m)';
        }


        function performEdgeCognitiveAnalysis(detections) {
            const environment = currentEnvironment;
            const analysis = { situationSummary: '', riskAssessment: 'BAIXO', cognitiveInsights: [], recommendedActions: [] };
            const detectedTypes = detections.map(d => d.type);
            
            let riskLevel = 'BAIXO';
            let highRiskItems = [];

            // 1. Avalia√ß√£o de Risco com L√≥gica de Dist√¢ncia
            detections.forEach(det => {
                const distance = calculateSimulatedDistance(det);
                det.distance = distance; 
                
                // CR√çTICO: Risco m√°ximo E (IMINENTE ou PR√ìXIMO)
                if (det.risk === 'CRITICO' && (distance === 'IMINENTE (1-2m)' || distance === 'PR√ìXIMO (3-5m)')) {
                    highRiskItems.push(det);
                    riskLevel = 'CRITICO';
                } else if (det.risk === 'ALTO' && distance === 'IMINENTE (1-2m)') {
                    highRiskItems.push(det);
                    if (riskLevel !== 'CRITICO') riskLevel = 'ALTO';
                } else if (det.risk === 'MEDIO' && distance === 'IMINENTE (1-2m)') {
                    if (riskLevel === 'BAIXO') riskLevel = 'MEDIO';
                }
            });

            // --- Determina√ß√£o da A√ß√£o ---
            if (riskLevel === 'CRITICO') {
                analysis.cognitiveInsights.push(`üö® RISCO CR√çTICO IMINENTE: ${highRiskItems.map(d => d.type).join(', ')}.`);
                analysis.recommendedActions.push('GLOBAL HALT: Parada Imediata. (Zero Parada Desnecess√°ria)');
            } else if (riskLevel === 'ALTO') {
                analysis.cognitiveInsights.push('‚ö†Ô∏è Risco ALTO: Desacelerar e Re-rotear em 500ms.');
                analysis.recommendedActions.push('Reduzir velocidade e acionar Gemini (Nuvem) para valida√ß√£o.');
            } else if (riskLevel === 'MEDIO') {
                analysis.cognitiveInsights.push('üü° Risco M√âDIO: Item pr√≥ximo detectado. Aten√ß√£o redobrada.');
                analysis.recommendedActions.push('Manter velocidade e ajustar rota no Edge.');
            } else {
                 analysis.cognitiveInsights.push(`‚úÖ Ambiente ${environment.toUpperCase()} seguro. ${detections.length} objetos detectados.`);
                 analysis.recommendedActions.push('Proceder com velocidade operacional m√°xima.');
            }
            
            // 2. Otimiza√ß√£o (Simula√ß√£o de ML)
            const efficiency = parseFloat(document.getElementById('cloud-efficiency').textContent) / 100 || 0.3333;
            analysis.cognitiveInsights.push(`üéØ Otimiza√ß√£o de Rota ML: Clear path detected.`);

            analysis.riskAssessment = riskLevel;

            // 3. Resposta Formatada (Output de Neg√≥cio)
            return `üîÆ EDGE COGNITIVE ANALYSIS (Pi Processor)

DETECTED OBJECTS (Localiza√ß√£o):
${detections.map(det => `‚Ä¢ ${det.type} (${Math.round(det.confidence * 100)}%) - ${det.distance}`).join('\n')}

RISK ASSESSMENT: ${analysis.riskAssessment}
EDGE INSIGHTS (45ms):
${analysis.cognitiveInsights.join('\n')}

RECOMMENDED ACTION:
${analysis.recommendedActions.join('\n')}

SAFETY SCORE: ${riskLevel === 'CRITICO' ? '10/100' : riskLevel === 'ALTO' ? '40/100' : '98/100'}
CLOUD USAGE: ${efficiency.toFixed(2)}% reduction achieved`;
        }

        // --- Fun√ß√µes de M√©tricas e Inicializa√ß√£o ---

        function updateMetrics(detections) {
            const baseEfficiency = 33.33;
            const activityBonus = analysisCount * 0.005;
            const liveEfficiency = Math.min(33.8, baseEfficiency + activityBonus);
            
            document.getElementById('cloud-efficiency').textContent = liveEfficiency.toFixed(2) + '%';
            
            const liveLatency = 45 + Math.floor(Math.random() * 4 - 2);
            document.getElementById('ai-latency').textContent = liveLatency + 'ms';
            
            const currentDetections = parseInt(document.getElementById('messages-today').textContent) || 0;
            document.getElementById('messages-today').textContent = (currentDetections + detections.length).toLocaleString();
            
            calculateROI();
        }

        function calculateROI() {
            const robotCount = parseInt(document.getElementById('robot-count').value) || 100;
            const cloudCost = parseInt(document.getElementById('cloud-cost').value) || 1200;
            const efficiency = parseFloat(document.getElementById('cloud-efficiency').textContent) / 100 || 0.3333;
            
            const annualSavings = robotCount * cloudCost * efficiency * 12;
            
            document.getElementById('calculated-savings').textContent = '$' + annualSavings.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            document.getElementById('roi-value').textContent = '$' + (annualSavings / 1000000).toFixed(1) + 'M';
        }

        function updateUptime() {
            setInterval(() => {
                const now = new Date();
                const uptime = Math.floor((now - startTime) / 1000);
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                const seconds = uptime % 60;
                
                document.getElementById('system-uptime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('api-status');
            const colors = {
                info: '#00b4db',
                success: '#28a745', 
                warning: '#ffc107',
                error: '#dc3545'
            };
            
            statusEl.textContent = message;
            statusEl.style.background = colors[type] || colors.info;
            statusEl.style.color = (type === 'warning' || type === 'success') ? '#333' : 'white';
        }

        // üöÄ INITIALIZE SYSTEM
        updateUptime();
        calculateROI();
        drawSimulatedBackground(); 
        updateStatus('üü° System Initialized. Press "Start Vision"', 'warning');
        
        // üîí IP PROTECTION
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'p' || e.key === 's' || e.key === 'u')) {
                e.preventDefault();
                alert('üö´ PSAE Intellectual Property Protected');
            }
        });

        console.log('üöÄ PSAE Future Vision Demo Loaded Successfully!');
    </script>
</body>
</html>
